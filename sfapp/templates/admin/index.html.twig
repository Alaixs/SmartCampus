<!DOCTYPE html>
<html lang="fr">

<head>
    <title>SmartCampus</title>
    <link rel="stylesheet" href="{{ asset('assets/css/admin.css') }}">
    <link rel="icon" href="{{ asset('assets/img/favicon.ico') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
{% include 'partial/header.html.twig'%}
<section class='planExperimentation'>
    <div class="planExperimentation-div">
        <div class='planExperimentation-div-title'>
            <p class="planExperimentation-p-title">Plan d'expérimentation</p>
            {% if is_granted('ROLE_TECHNICIEN') %}
                <div class="add-or-del-div">
                    <a href="{{ path('addAU') }}" class="planExperimentation-div-button-add">Ajouter un système
                        d'acquisition</a>
                    {% if roomList %}
                        <a href="{{ path('removeAU') }}"
                           class="planExperimentation-div-button-add add-or-del-div ">Supprimer un S.A</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        {% if roomList is empty %}
            {% if not formSubmitted %}
                <div class="noRoom">
                    <p class="noRoomText">Aucune salle n'a été ajoutée pour le moment. Commencez par en ajouter une.</p>
                </div>
            {% elseif formSubmitted and filtersApplied %}
                <div class="noRoom">
                    <p class="noRoomText">Aucune salle ne correspond aux filtres sélectionnés.</p>
                </div>
            {% elseif formSubmitted and not filtersApplied %}
                <div class="noRoom">
                    <p class="noRoomText">Aucune salle n'a été ajoutée pour le moment. Commencez par en ajouter une.</p>
                </div>
            {% endif %}
        {% else %}
            <div class='planExperimentation-div-array planExperimentation-div-array-columnName'>
                <div class="planExperimentation-div-div">
                    SALLES
                </div>
                {% if is_granted('ROLE_ADMIN') %}
                    <div class="planExperimentation-div-div">
                        NIVEAU DE CONFORT
                    </div>
                {% elseif is_granted('ROLE_TECHNICIEN') %}
                    <div class="planExperimentation-div-div">
                        SYSTEMES D'ACQUISITION
                    </div>
                {% endif %}
                <div class="planExperimentation-div-div">
                    ETAT DE L'INSTALLATION
                </div>
                <div class="planExperimentation-div-div">
                    ETAT DE FONCTIONNEMENT
                </div>
            </div>
            <div class="planExperimentation-div-allRoom">
                {% for room in roomList %}
                    <div class='planExperimentation-div-array'>
                    <div class="planExperimentation-div-div planExperimentation-div-roomName">
                        <div class="planExperimentation-div-roomName-div">
                            <div class="infosRoomAndAU">{{ room.name }}</div>
                        </div>
                    </div>
                    <!-- Niveau de confort (seulement référent) -->
                    {% if is_granted('ROLE_ADMIN') %}

                        {% if room.acquisitionUnit %}
                            <div class='planExperimentation-div-div greyBackground' id="comfortIndicatorRoom{{ room.id }}">
                                Chargement des données...
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', function () {
                                    fetch('/getRoomComfort/{{ room.id }}')
                                        .then(function (response) {
                                            if (!response.ok) {
                                                throw new Error('Erreur lors de la récupération des données de confort');
                                            }
                                            return response.json();
                                        })
                                        .then(function (data) {
                                            updateRoomsComfortIndicator(data, {{ room.id }});
                                        })
                                        .catch(function (error) {
                                            console.error(error.message);
                                        });
                                });
                                function updateRoomsComfortIndicator(data, roomId) {
                                    let div = document.getElementById('comfortIndicatorRoom' + roomId);
                                    let tempComfort = data['temp'];
                                    let humComfort = data['hum'];
                                    let co2Comfort = data['co2'];
                                    if (tempComfort === 'OK' && humComfort === 'OK' && co2Comfort === 'OK') {
                                        div.classList.remove("greyBackground");
                                        div.classList.add('greenBackground');
                                        div.innerHTML = `<div class='cursorHelp'><span
                                                title="Température : ` + tempComfort + `\n Humidité : ` + humComfort + `\n Co2 : ` + co2Comfort + `">Confortable</span></div>`;
                                    }
                                    else if (tempComfort === 'Très mauvais' && humComfort === 'Très mauvais' && co2Comfort === 'Très mauvais') {
                                        div.classList.remove("greyBackground");
                                        div.classList.add('redBackground');
                                        div.innerHTML = `<div class='cursorHelp'><span
                                                title="Température : ` + tempComfort + `\n Humidité : ` + humComfort + `\n Co2 : ` + co2Comfort + `"><p>Inconfortable</span></div>`;
                                    }
                                    else if (tempComfort === 'Aucune données' && humComfort === 'Aucune données' && co2Comfort === 'Aucune données') {
                                        div.innerHTML = `<div>Aucune donnée</div>`;
                                    }
                                    else {
                                        console.log(data);
                                        div.classList.remove("greyBackground");
                                        div.classList.add('orangeBackground');
                                        div.innerHTML = `<div class='cursorHelp'><span
                                                title="Température : ` + tempComfort + `\n Humidité : ` + humComfort + `\n Co2 : ` + co2Comfort + `">Peu confortable</span></div>`;
                                    }
                                }
                            </script>
                        {% else %}
                            <div class='planExperimentation-div-div greyBackground'>
                                Aucune donnée
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- SA -->
                        {% if room.acquisitionUnit is empty %}
                            <div class="planExperimentation-div-div">
                                <p>-</p>
                            </div>
                        {% else %}
                            <div class="planExperimentation-div-div">
                                <p>{{ room.acquisitionUnit }}</p>
                            </div>
                        {% endif %}
                    {% endif %}

                    {% if room.acquisitionUnit and room.acquisitionUnit.state != "En attente d'installation" %}
                        <!-- ETAT DE L'INSTALLATION DU SYSTEME D'ACQUISITION -->
                        <div class="planExperimentation-div-div">
                            Installé
                        </div>
                        <!-- ETAT DE FONCTIONNEMENT -->
                        <div class="planExperimentation-div-div">
                            {{ room.acquisitionUnit.state }}
                        </div>
                    {% elseif room.acquisitionUnit %}
                        <div class="planExperimentation-div-div">
                            En attente d'installation
                        </div>
                        <div class="planExperimentation-div-div">
                             -
                        </div>
                    {% else %}
                        <div class="planExperimentation-div-div">
                            Aucun système d'acquisition attribué
                        </div>
                        <div class="planExperimentation-div-div">
                             -
                        </div>
                    {% endif %}
                    <!-- Button voir plus et rendre opérationnel -->
                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('roomDetail', {'room' : room.id}) }}"
                           class="planExperimentation-div-voir-plus">Voir plus</a>
                    {% else %}
                        {% if room.acquisitionUnit %}
                            <a href="{{ path('manageAcquisitionUnit', {'acquisitionUnit' :room.acquisitionUnit.id}) }}"
                               class="planExperimentation-div-voir-plus">Gérer le SA</a>
                        {% else %}
                            <a href="{{ path('assignAU', {'room' :room.id}) }}"
                               class="planExperimentation-div-voir-plus">Affecter un SA</a>
                        {% endif %}
                    {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% if is_granted('ROLE_ADMIN') %}
            <div class='planExperimentation-div-array'>
                <a href="{{ path('addRoom') }}" class="planExperimentation-div-button-add addRoom">Ajouter une salle</a>
            </div>
        {% endif %}
    </div>
    {% include 'components/search_data.html.twig' %}

</section>
{% include 'partial/footer.html.twig' %}
</body>

</html>